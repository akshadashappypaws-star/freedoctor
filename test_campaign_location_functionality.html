<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Campaign Location Functionality</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1e293b;
            color: white;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #475569;
            border-radius: 8px;
            background: #334155;
            color: white;
            box-sizing: border-box;
        }
        input:focus {
            border-color: #3b82f6;
            outline: none;
        }
        .location-container {
            position: relative;
        }
        .location-buttons {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
        }
        .location-btn {
            background: none;
            border: none;
            color: #10b981;
            cursor: pointer;
            padding: 5px;
        }
        .location-btn:hover {
            color: #059669;
        }
        .location-btn:disabled {
            color: #6b7280;
            cursor: not-allowed;
        }
        .feedback {
            margin-top: 10px;
            font-size: 12px;
            color: #9ca3af;
        }
        .feedback.success {
            color: #10b981;
        }
        .feedback.error {
            color: #ef4444;
        }
        .map-container {
            width: 100%;
            height: 200px;
            background: #475569;
            border: 1px solid #64748b;
            border-radius: 8px;
            margin-top: 10px;
            display: none;
        }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .hidden {
            display: none;
        }
        .status-box {
            background: #374151;
            border: 1px solid #4b5563;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .status-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <h1><i class="fas fa-map-marker-alt"></i> Campaign Location Functionality Test</h1>
    
    <div class="status-box">
        <div class="status-title">Test Status</div>
        <div id="testStatus">Initializing...</div>
    </div>

    <form id="testForm">
        <div class="form-group">
            <label for="campaignLocation">Campaign Location *</label>
            <div class="location-container">
                <input type="text" 
                       id="campaignLocation" 
                       name="location" 
                       placeholder="Type address or click GPS button"
                       required>
                <div class="location-buttons">
                    <button type="button" id="getCurrentLocationBtn" class="location-btn" title="Use current location">
                        <i class="fas fa-location-crosshairs"></i>
                    </button>
                    <span id="locationStatus" class="hidden">
                        <i class="fas fa-check-circle" style="color: #10b981;" title="Location verified"></i>
                    </span>
                </div>
            </div>
            <input type="hidden" id="campaignLatitude" name="latitude">
            <input type="hidden" id="campaignLongitude" name="longitude">
            <div id="locationMap" class="map-container"></div>
            <div id="locationFeedback" class="feedback">
                <span id="coordinatesDisplay"></span>
                <span id="addressVerification"></span>
            </div>
            <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">
                <i class="fas fa-info-circle"></i>
                Precise coordinates are required for accurate distance calculations
            </p>
        </div>

        <div class="form-group">
            <button type="button" class="test-button" onclick="testCurrentLocation()">
                <i class="fas fa-location-arrow"></i> Test Current Location
            </button>
            <button type="button" class="test-button" onclick="testManualAddress()">
                <i class="fas fa-keyboard"></i> Test Manual Address
            </button>
            <button type="button" class="test-button" onclick="validateLocationTest()">
                <i class="fas fa-check"></i> Test Validation
            </button>
            <button type="button" class="test-button" onclick="clearLocationTest()">
                <i class="fas fa-trash"></i> Clear Location
            </button>
        </div>

        <div class="status-box">
            <div class="status-title">Current Location Data</div>
            <div id="locationData">
                <p><strong>Latitude:</strong> <span id="displayLat">Not set</span></p>
                <p><strong>Longitude:</strong> <span id="displayLng">Not set</span></p>
                <p><strong>Address:</strong> <span id="displayAddress">Not set</span></p>
            </div>
        </div>
    </form>

    <!-- Google Maps API -->
    <script>
        // Global variables for location services
        let userLatitude = null;
        let userLongitude = null;
        let autocomplete = null;
        let map = null;
        let marker = null;
        let geocoder = null;

        // Initialize Google Maps - this is the callback function
        function initMaps() {
            console.log('Google Maps API loaded, initializing location services...');
            document.getElementById('testStatus').innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Google Maps API loaded successfully';
            
            // Initialize geocoder
            geocoder = new google.maps.Geocoder();
            
            // Initialize location search functionality
            initLocationSearch();
        }

        // Initialize Google Maps location services
        function initLocationSearch() {
            console.log('Setting up location search functionality...');

            // Initialize autocomplete for location input
            const locationInput = document.getElementById('campaignLocation');
            if (locationInput && typeof google !== 'undefined' && google.maps && google.maps.places) {
                try {
                    autocomplete = new google.maps.places.Autocomplete(locationInput, {
                        types: ['geocode', 'establishment'],
                        componentRestrictions: {
                            country: 'IN'
                        },
                        fields: ['formatted_address', 'geometry', 'name', 'place_id']
                    });

                    // Listen for place selection
                    autocomplete.addListener('place_changed', function() {
                        const place = autocomplete.getPlace();
                        console.log('Place selected:', place);

                        if (place.geometry && place.geometry.location) {
                            userLatitude = place.geometry.location.lat();
                            userLongitude = place.geometry.location.lng();

                            // Set the coordinates in hidden fields
                            document.getElementById('campaignLatitude').value = userLatitude;
                            document.getElementById('campaignLongitude').value = userLongitude;

                            console.log('Location coordinates set:', {
                                lat: userLatitude,
                                lng: userLongitude,
                                address: place.formatted_address || place.name
                            });

                            // Update UI feedback
                            updateLocationFeedback(userLatitude, userLongitude, place.formatted_address || place.name);
                            
                            // Show location verification
                            showLocationVerification(true);
                            
                            // Show mini map if container exists
                            showLocationOnMap(userLatitude, userLongitude);
                            
                            // Update display
                            updateLocationDisplay();
                        } else {
                            console.warn('Selected place has no geometry');
                            showLocationError('Please select a valid location from the dropdown suggestions');
                            clearLocationData();
                        }
                    });

                    // Handle manual input validation
                    locationInput.addEventListener('blur', function() {
                        const inputValue = this.value.trim();
                        if (inputValue && (!userLatitude || !userLongitude)) {
                            // If user typed something but didn't select from autocomplete
                            console.log('Manual input detected, attempting geocoding...');
                            geocodeAddress(inputValue);
                        }
                    });

                    console.log('Autocomplete initialized successfully');
                    document.getElementById('testStatus').innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Location search functionality ready';
                } catch (error) {
                    console.error('Error initializing autocomplete:', error);
                    showLocationError('Failed to initialize location search. Please refresh the page.');
                }
            } else {
                console.error('Google Maps Places API not available');
                document.getElementById('testStatus').innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Google Maps Places API not available';
            }

            // Initialize current location button
            const getCurrentLocationBtn = document.getElementById('getCurrentLocationBtn');
            if (getCurrentLocationBtn) {
                getCurrentLocationBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    getCurrentLocation();
                });
            }
        }

        // Geocode address manually entered by user
        function geocodeAddress(address) {
            if (!geocoder) {
                console.error('Geocoder not initialized');
                return;
            }

            geocoder.geocode({ address: address, componentRestrictions: { country: 'IN' } }, function(results, status) {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    userLatitude = location.lat();
                    userLongitude = location.lng();

                    // Set coordinates in hidden fields
                    document.getElementById('campaignLatitude').value = userLatitude;
                    document.getElementById('campaignLongitude').value = userLongitude;

                    // Update location input with formatted address
                    document.getElementById('campaignLocation').value = results[0].formatted_address;

                    console.log('Address geocoded successfully:', {
                        lat: userLatitude,
                        lng: userLongitude,
                        address: results[0].formatted_address
                    });

                    // Update UI feedback
                    updateLocationFeedback(userLatitude, userLongitude, results[0].formatted_address);
                    showLocationVerification(true);
                    showLocationOnMap(userLatitude, userLongitude);
                    updateLocationDisplay();
                } else {
                    console.error('Geocoding failed:', status);
                    showLocationError('Could not find the specified location. Please try a different address.');
                    clearLocationData();
                }
            });
        }

        // Get user's current location
        function getCurrentLocation() {
            const btn = document.getElementById('getCurrentLocationBtn');
            const locationInput = document.getElementById('campaignLocation');

            if (!navigator.geolocation) {
                showLocationError('Geolocation is not supported by this browser');
                return;
            }

            // Show loading state
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            btn.title = 'Getting location...';

            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 300000 // 5 minutes
            };

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLatitude = position.coords.latitude;
                    userLongitude = position.coords.longitude;

                    // Set coordinates in hidden fields
                    document.getElementById('campaignLatitude').value = userLatitude;
                    document.getElementById('campaignLongitude').value = userLongitude;

                    console.log('Current location detected:', {
                        lat: userLatitude,
                        lng: userLongitude,
                        accuracy: position.coords.accuracy
                    });

                    // Reverse geocode to get address
                    if (geocoder) {
                        const latlng = new google.maps.LatLng(userLatitude, userLongitude);

                        geocoder.geocode({ location: latlng }, function(results, status) {
                            if (status === 'OK' && results[0]) {
                                locationInput.value = results[0].formatted_address;
                                
                                // Update UI feedback
                                updateLocationFeedback(userLatitude, userLongitude, results[0].formatted_address);
                                showLocationVerification(true);
                                showLocationOnMap(userLatitude, userLongitude);

                                console.log('Address resolved:', results[0].formatted_address);
                            } else {
                                console.error('Reverse geocoding failed:', status);
                                locationInput.value = `${userLatitude.toFixed(6)}, ${userLongitude.toFixed(6)}`;
                                updateLocationFeedback(userLatitude, userLongitude, 'Current Location');
                                showLocationVerification(true);
                                showLocationOnMap(userLatitude, userLongitude);
                            }
                            
                            // Reset button
                            resetLocationButton(btn);
                            updateLocationDisplay();
                        });
                    } else {
                        // Fallback if geocoder not available
                        locationInput.value = `${userLatitude.toFixed(6)}, ${userLongitude.toFixed(6)}`;
                        updateLocationFeedback(userLatitude, userLongitude, 'Current Location');
                        showLocationVerification(true);
                        resetLocationButton(btn);
                        updateLocationDisplay();
                    }
                },
                function(error) {
                    console.error('Geolocation error:', error);
                    let errorMessage = 'Could not detect location';
                    
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied. Please enable location permissions and try again.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable. Please try again or enter address manually.';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out. Please try again.';
                            break;
                        default:
                            errorMessage = 'An unknown error occurred while getting location.';
                            break;
                    }
                    
                    showLocationError(errorMessage);
                    resetLocationButton(btn);
                },
                options
            );
        }

        // Reset location button to original state
        function resetLocationButton(btn) {
            btn.innerHTML = '<i class="fas fa-location-crosshairs"></i>';
            btn.disabled = false;
            btn.title = 'Use current location';
        }

        // Show location on mini map
        function showLocationOnMap(lat, lng) {
            const mapContainer = document.getElementById('locationMap');
            if (mapContainer && typeof google !== 'undefined' && google.maps) {
                mapContainer.style.display = 'block';
                
                // Initialize map
                map = new google.maps.Map(mapContainer, {
                    center: { lat: lat, lng: lng },
                    zoom: 15,
                    mapTypeId: google.maps.MapTypeId.ROADMAP,
                    disableDefaultUI: true,
                    zoomControl: true,
                    styles: [
                        {
                            featureType: 'all',
                            elementType: 'geometry.fill',
                            stylers: [{ color: '#1e293b' }]
                        },
                        {
                            featureType: 'water',
                            elementType: 'geometry',
                            stylers: [{ color: '#0f172a' }]
                        }
                    ]
                });

                // Add marker
                if (marker) {
                    marker.setMap(null);
                }
                
                marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: map,
                    title: 'Campaign Location',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="16" cy="16" r="8" fill="#3B82F6"/>
                                <circle cx="16" cy="16" r="4" fill="white"/>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(32, 32),
                        anchor: new google.maps.Point(16, 16)
                    }
                });
            }
        }

        // Update location feedback display
        function updateLocationFeedback(lat, lng, address) {
            const coordinatesDisplay = document.getElementById('coordinatesDisplay');
            const addressVerification = document.getElementById('addressVerification');
            
            if (coordinatesDisplay) {
                coordinatesDisplay.textContent = `Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                coordinatesDisplay.classList.remove('hidden');
            }
            
            if (addressVerification) {
                addressVerification.innerHTML = '<i class="fas fa-check-circle"></i> Location verified';
                addressVerification.classList.remove('hidden');
                addressVerification.classList.add('success');
            }
            
            // Show feedback div
            const feedbackDiv = document.getElementById('locationFeedback');
            if (feedbackDiv) {
                feedbackDiv.classList.remove('hidden');
            }
        }

        // Clear location data
        function clearLocationData() {
            userLatitude = null;
            userLongitude = null;
            document.getElementById('campaignLatitude').value = '';
            document.getElementById('campaignLongitude').value = '';
            document.getElementById('campaignLocation').value = '';
            
            // Hide feedback
            const coordinatesDisplay = document.getElementById('coordinatesDisplay');
            const addressVerification = document.getElementById('addressVerification');
            const feedbackDiv = document.getElementById('locationFeedback');
            
            if (coordinatesDisplay) coordinatesDisplay.classList.add('hidden');
            if (addressVerification) addressVerification.classList.add('hidden');
            if (feedbackDiv) feedbackDiv.classList.add('hidden');
            
            showLocationVerification(false);
            
            // Hide map
            const mapContainer = document.getElementById('locationMap');
            if (mapContainer) {
                mapContainer.style.display = 'none';
            }
            
            updateLocationDisplay();
        }

        // Show location verification status
        function showLocationVerification(isVerified) {
            const status = document.getElementById('locationStatus');
            if (status) {
                if (isVerified) {
                    status.classList.remove('hidden');
                } else {
                    status.classList.add('hidden');
                }
            }
        }

        // Show location error
        function showLocationError(message) {
            console.error('Location error:', message);
            
            // Show error using SweetAlert if available
            if (typeof Swal !== 'undefined') {
                Swal.fire({
                    icon: 'warning',
                    title: 'Location Error',
                    text: message,
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 4000,
                    timerProgressBar: true
                });
            } else {
                // Fallback to alert
                alert('Location Error: ' + message);
            }
            
            showLocationVerification(false);
        }

        // Validate location before form submission
        function validateLocation() {
            const lat = document.getElementById('campaignLatitude').value;
            const lng = document.getElementById('campaignLongitude').value;
            const locationInput = document.getElementById('campaignLocation').value.trim();
            
            if (!locationInput) {
                showLocationError('Please enter a campaign location');
                document.getElementById('campaignLocation').focus();
                return false;
            }
            
            if (!lat || !lng || lat === '0' || lng === '0') {
                showLocationError('Please select a valid location with coordinates. Use the GPS button or select from dropdown suggestions.');
                document.getElementById('campaignLocation').focus();
                return false;
            }
            
            // Validate coordinate ranges (basic check)
            const latitude = parseFloat(lat);
            const longitude = parseFloat(lng);
            
            if (isNaN(latitude) || isNaN(longitude)) {
                showLocationError('Invalid coordinates detected. Please select location again.');
                return false;
            }
            
            // Check if coordinates are within reasonable bounds for India
            if (latitude < 6 || latitude > 37 || longitude < 68 || longitude > 98) {
                showLocationError('Location appears to be outside India. Please verify the location.');
                return false;
            }
            
            console.log('Location validation passed:', { lat: latitude, lng: longitude });
            return true;
        }

        // Update location display
        function updateLocationDisplay() {
            document.getElementById('displayLat').textContent = userLatitude ? userLatitude.toFixed(6) : 'Not set';
            document.getElementById('displayLng').textContent = userLongitude ? userLongitude.toFixed(6) : 'Not set';
            document.getElementById('displayAddress').textContent = document.getElementById('campaignLocation').value || 'Not set';
        }

        // Test functions
        function testCurrentLocation() {
            getCurrentLocation();
        }

        function testManualAddress() {
            const testAddress = 'Mumbai, Maharashtra, India';
            document.getElementById('campaignLocation').value = testAddress;
            geocodeAddress(testAddress);
        }

        function validateLocationTest() {
            const isValid = validateLocation();
            if (isValid) {
                Swal.fire({
                    icon: 'success',
                    title: 'Validation Passed',
                    text: 'Location data is valid and ready for submission!',
                    timer: 2000
                });
            }
        }

        function clearLocationTest() {
            clearLocationData();
            Swal.fire({
                icon: 'info',
                title: 'Location Cleared',
                text: 'All location data has been cleared.',
                timer: 2000
            });
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, checking for Google Maps API...');
            document.getElementById('testStatus').innerHTML = '<i class="fas fa-clock" style="color: #f59e0b;"></i> Waiting for Google Maps API...';
            
            // Check if Google Maps API is already loaded
            if (typeof google !== 'undefined' && google.maps) {
                console.log('Google Maps API already loaded');
                initMaps();
            } else {
                console.log('Waiting for Google Maps API to load...');
            }
        });
    </script>

    <!-- Load Google Maps API with callback -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAaAGMxei5r_4i_3Yw2LBNLtu56KE5mVek&libraries=places&callback=initMaps"
        async
        defer
        onerror="console.error('Failed to load Google Maps API'); document.getElementById('testStatus').innerHTML = '<i class=\'fas fa-exclamation-triangle\' style=\'color: #ef4444;\'></i> Failed to load Google Maps API';"
    ></script>
</body>
</html>
